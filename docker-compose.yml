version: '3.8'

services:
  openldap:
    image: osixia/openldap:1.5.0
    container_name: openldap
    environment:
      LDAP_ORGANISATION: "Example Org"
      LDAP_DOMAIN: "example.com"
      LDAP_ADMIN_PASSWORD: "admin"
    ports:
      - "389:389"
      - "636:636"
    volumes:
      - ldap-data:/var/lib/ldap
      - ldap-config:/etc/ldap/slapd.d

  prefect:
    build:
      context: ./prefect/flows
    container_name: prefect
    depends_on:
      - openldap
    environment:
      PREFECT_API_URL: "http://localhost:4200/api"
    ports:
      - "4200:4200"
    volumes:
      - ./prefect/flows:/prefect

  mcp_tools:
    build:
      context: ./mcp_tools
    container_name: mcp_tools
    depends_on:
      - openldap
      - prefect
    ports:
      - "5001:5001"
    volumes:
      - ./mcp_tools:/mcp_tools
    extra_hosts:
      - "host.docker.internal:host-gateway"
  postgres:
    image: postgres:15
    container_name: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 123456
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
  backend:
    build:
      context: ./backend
    container_name: backend
    depends_on:
      - openldap
      - prefect
      - mcp_tools
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
    env_file:
      - ./backend/.env
    volumes:
      - ./env-config.json:/app
      - ./backend/app:/app
      - ./vision-ui-dashboard-react:/vision_ui
      - ./prefect/flows:/prefect
      - ./mcp_tools:/mcp_tools

      
  vision_ui:
    build:
      context: ./vision-ui-dashboard-react
    container_name: vision_ui
    depends_on:
      - backend
    ports:
      - "3000:80"
    volumes:
      - ./vision-ui-dashboard-react:/vision_ui

volumes:
  ldap-data:
  ldap-config:
  pgdata:
